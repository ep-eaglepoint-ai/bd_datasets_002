version: '3.8'

services:
  # Run tests against repository_before (expected to fail many tests)
  test-before:
    build:
      context: .
      dockerfile: Dockerfile
    working_dir: /app/repository_before
    environment:
      - PYTHONPATH=/app/repository_before:/app
      - DJANGO_SETTINGS_MODULE=test_settings
      - TARGET_REPOSITORY=repository_before
    command: >
      sh -c "python -m pytest /app/tests/ -v --tb=short --ds=test_settings"

  # Run tests against repository_after (expected to pass all tests)
  test-after:
    build:
      context: .
      dockerfile: Dockerfile
    working_dir: /app/repository_after
    environment:
      - PYTHONPATH=/app/repository_after:/app
      - DJANGO_SETTINGS_MODULE=test_settings
      - TARGET_REPOSITORY=repository_after
    command: >
      sh -c "python -m pytest /app/tests/ -v --tb=short --ds=test_settings"

  # Run evaluation script to compare both implementations
  evaluation:
    build:
      context: .
      dockerfile: Dockerfile
    working_dir: /app
    environment:
      - PYTHONPATH=/app
    volumes:
      # Mount evaluation directory to persist report.json to host
      - ./evaluation:/app/evaluation
    command: >
      sh -c "python evaluation/evaluation.py"
