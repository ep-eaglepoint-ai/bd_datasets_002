services:
  # Test suite - Validates all requirements using mock tests
  test-after:
    build: .
    command: >
      sh -c "
      cd /app/repository_after &&
      protoc -I/usr/include -I/usr/local/include -I. --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative proto/ratelimiter.proto &&
      cd /app/tests &&
      go mod tidy &&
      echo '=== Running All Requirements Validation ===' &&
      go test -v -race -timeout 5m -run '^TestMockAllRequirements$$' ./...
      "
    volumes:
      - .:/app
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock

  # Meta tests - Validates test infrastructure and requirements
  # Generates JSON report in evaluation/reports/<timestamp>/report.json
  evaluation:
    build: .
    command: >
      sh -c "
      cd /app/repository_after &&
      protoc -I/usr/include -I/usr/local/include -I. --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative proto/ratelimiter.proto &&
      cd /app/tests &&
      go mod tidy &&
      cd /app/evaluation &&
      echo '=== Running Evaluation (Meta Tests) ===' &&
      go run evaluation.go
      "
    volumes:
      - .:/app
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock