services:
  test-after:
    build: .
    command: >
      sh -c "
      cd /app/repository_after &&
      protoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative proto/ratelimiter.proto &&
      cd /app/tests &&
      go mod tidy &&
      go test -v -race -timeout 5m ./...
      "
    volumes:
      - .:/app
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock

  evaluation:
    build: .
    command: >
      sh -c "
      cd /app/evaluation &&
      go mod tidy &&
      go run evaluation.go
      "
    volumes:
      - .:/app
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
