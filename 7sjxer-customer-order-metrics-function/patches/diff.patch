diff --git a/repository_before/customer_order.sql b/repository_after/customer_order.sql
index ea52894..b1716fd 100644
--- a/repository_before/customer_order.sql
+++ b/repository_after/customer_order.sql
@@ -11,39 +11,20 @@ RETURNS TABLE(
 )
 LANGUAGE plpgsql
 AS $$
-DECLARE
-    v_total_orders INT := 0;
-    v_completed_orders INT := 0;
-    v_cancelled_orders INT := 0;
-    v_total_revenue NUMERIC := 0;
-    r RECORD;
 BEGIN
-    FOR r IN
-        SELECT id, status, total_price
-        FROM orders
-        WHERE customer_id = p_customer_id
-          AND DATE(created_at) >= p_start_date
-          AND DATE(created_at) <= p_end_date
-    LOOP
-        v_total_orders := v_total_orders + 1;
-
-        IF r.status = 'COMPLETED' THEN
-            v_completed_orders := v_completed_orders + 1;
-            v_total_revenue := v_total_revenue + r.total_price;
-        ELSIF r.status = 'CANCELLED' THEN
-            v_cancelled_orders := v_cancelled_orders + 1;
-        END IF;
-    END LOOP;
-
-    IF v_total_orders IS NULL THEN
-        v_total_orders := 0;
+    IF p_start_date > p_end_date THEN
+        RAISE EXCEPTION 'Invalid date range: start_date (%) must be <= end_date (%)', p_start_date, p_end_date;
     END IF;
 
     RETURN QUERY
     SELECT
-        v_total_orders,
-        v_completed_orders,
-        v_cancelled_orders,
-        COALESCE(v_total_revenue, 0);
+        COUNT(*)::INT AS total_orders,
+        COUNT(*) FILTER (WHERE status = 'COMPLETED')::INT AS completed_orders,
+        COUNT(*) FILTER (WHERE status = 'CANCELLED')::INT AS cancelled_orders,
+        COALESCE(SUM(total_price) FILTER (WHERE status = 'COMPLETED'), 0) AS total_revenue
+    FROM orders
+    WHERE customer_id = p_customer_id
+      AND created_at >= p_start_date::timestamp
+      AND created_at < (p_end_date + INTERVAL '1 day')::timestamp;
 END;
 $$;
