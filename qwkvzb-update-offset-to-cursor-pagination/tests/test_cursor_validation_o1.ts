// test_cursor_validation_o1.ts
/**
 * TEST: O(1) CURSOR VALIDATION (NO DATABASE LOOKUP)
 * ==================================================
 * Verifies that invalid cursors are rejected in O(1) time
 * Target: Detect tampering without DB access
 * 
 * MUST FAIL on repository_before: No cursor support
 * MUST PASS on repository_after: O(1) hash validation
 */

import { topupTransactionDal } from '../repository_after/topupTransaction.dal';

async function testCursorValidation() {
    console.log('TEST: O(1) Cursor Validation (No DB Lookup)\\n');

    // Test 1: Malformed cursor (invalid base64)
    console.log('  Test 1: Malformed cursor (invalid base64)');

    // Warmup
    await topupTransactionDal({ method: 'get paginate', cursor: null, limit: 1, filters: {} });

    const startTime1 = performance.now();
    const result1 = await topupTransactionDal({
        method: 'get paginate',
        cursor: 'invalid!!!base64',
        limit: 10,
        filters: {},
    });
    const timing1 = performance.now() - startTime1;

    if (result1.statusCode !== 400) {
        console.error(`  ❌ FAILED: Expected status 400, got ${result1.statusCode}`);
        process.exit(1);
    }
    console.log(`  ✅ Rejected in ${timing1.toFixed(2)}ms (O(1) validation)`);

    // Test 2: Valid base64 but invalid JSON
    console.log('\\n  Test 2: Valid base64 but invalid JSON');
    const startTime2 = performance.now();
    const result2 = await topupTransactionDal({
        method: 'get paginate',
        cursor: Buffer.from('not valid json').toString('base64'),
        limit: 10,
        filters: {},
    });
    const timing2 = performance.now() - startTime2;

    if (result2.statusCode !== 400) {
        console.error(`  ❌ FAILED: Expected status 400, got ${result2.statusCode}`);
        process.exit(1);
    }
    console.log(`  ✅ Rejected in ${timing2.toFixed(2)}ms (O(1) validation)`);

    // Test 3: Valid JSON but tampered hash
    console.log('\\n  Test 3: Valid JSON but tampered hash');
    const tamperedCursor = {
        id: 12345,
        createdAt: Date.now(),
        hash: 'TAMPERED_HASH_0000000000000000000000000000000000000000000000',
        version: 1,
    };
    const startTime3 = performance.now();
    const result3 = await topupTransactionDal({
        method: 'get paginate',
        cursor: Buffer.from(JSON.stringify(tamperedCursor)).toString('base64'),
        limit: 10,
        filters: {},
    });
    const timing3 = performance.now() - startTime3;

    if (result3.statusCode !== 400) {
        console.error(`  ❌ FAILED: Expected status 400, got ${result3.statusCode}`);
        process.exit(1);
    }
    console.log(`  ✅ Rejected in ${timing3.toFixed(2)}ms (O(1) hash verification)`);

    // Test 4: Valid cursor (should succeed)
    console.log('\\n  Test 4: Valid cursor (generated by system)');

    // First, get a real cursor
    const initialResult = await topupTransactionDal({
        method: 'get paginate',
        cursor: null,
        limit: 10,
        filters: {},
    });

    if (!initialResult.body.nextCursor) {
        console.log(`  ⚠️  No nextCursor available (empty dataset or last page)`);
        console.log('\\n  ✅ PASSED: All cursor validation tests passed\\n');
        return;
    }

    const startTime4 = performance.now();
    const result4 = await topupTransactionDal({
        method: 'get paginate',
        cursor: initialResult.body.nextCursor,
        limit: 10,
        filters: {},
    });
    const timing4 = performance.now() - startTime4;

    if (result4.statusCode !== 200) {
        console.error(`  ❌ FAILED: Valid cursor rejected with status ${result4.statusCode}`);
        process.exit(1);
    }
    console.log(`  ✅ Accepted in ${timing4.toFixed(2)}ms (O(1) validation)`);

    // Verify all validations were O(1) (<10ms, typically <1ms)
    const allTimings = [timing1, timing2, timing3, timing4];
    const avgTiming = allTimings.reduce((a, b) => a + b, 0) / allTimings.length;

    console.log(`\\n  Average validation time: ${avgTiming.toFixed(2)}ms`);
    console.log(`  Complexity: O(1) - no database lookup required`);

    if (avgTiming > 10) {
        console.error(`  ❌ FAILED: Validation too slow (avg ${avgTiming.toFixed(2)}ms)`);
        process.exit(1);
    }

    console.log('\\n  ✅ PASSED: All cursors validated in O(1) time\\n');
}

// Run test
testCursorValidation().catch(error => {
    console.error('Test failed:', error);
    process.exit(1);
});
