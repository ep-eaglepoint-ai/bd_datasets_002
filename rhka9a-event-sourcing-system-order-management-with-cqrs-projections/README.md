# RHKA9A -  Event Sourcing System - Order Management with CQRS Projections

**Category:** sft

## Overview
- Task ID: RHKA9A
- Title:  Event Sourcing System - Order Management with CQRS Projections
- Category: sft
- Repository: ep-eaglepoint-ai/bd_datasets_002
- Branch: rhka9a-event-sourcing-system-order-management-with-cqrs-projections

## Requirements
- The event store must persist domain events to PostgreSQL with append-only semantics. Each event record must include a unique event ID, aggregate ID, sequential version number, timestamp, event type as fully qualified class name, and JSON payload. Events for the same aggregate must be stored with strictly increasing version numbers
- Optimistic locking must prevent concurrent modifications to the same aggregate. When saving events, the system must verify that the current aggregate version matches the expected version. If another transaction has already appended events, the save must fail with a concurrency exception rather than corrupting the event stream.
- The aggregate base class must manage uncommitted events, version tracking, and state rebuild from history. Concrete aggregates extend this base class and implement event application methods. The base class must support loading from event history, tracking new events generated by commands, and clearing uncommitted events after successful persistence
- Snapshot support must reduce aggregate load time by periodically saving aggregate state. When loading an aggregate, the system should first check for a snapshot and then replay only events after the snapshot version. Snapshots must be created in separate transactions to avoid blocking command processing
- he order aggregate must handle CreateOrder, AddItem, RemoveItem, and SubmitOrder commands. Each command must validate business rules before generating the corresponding event. Orders can only have items added or removed while in draft status, and empty orders cannot be submitted.
- Domain events must be immutable after creation. Use Java records or final fields with constructor-only initialization. Events must serialize to JSON with Jackson and deserialize back to the correct concrete event type using polymorphic type handling.
- Projections must subscribe to domain events and maintain denormalized read models. The order projection must track order ID, customer ID, status, total amount, item count, and timestamps. Projection event handlers must be idempotent, processing the same event multiple times without changing the result.
- Projection rebuilds must support reprocessing the entire event history without running out of memory. Events should be loaded in batches or streamed rather than loaded all at once. Rebuilds must not block ongoing command processing or event publishing
- Event publication must occur after successful event persistence. Use Spring's application event publisher to notify projections of new events. Projection updates should run in separate transactions so that projection failures do not roll back command transactions
- The system must use only Spring Boot 3.x, Spring Data JPA, PostgreSQL, and Jackson. No external event sourcing libraries such as Axon Framework or EventStoreDB are permitted. All framework code must be implemented from scratch using standard Spring components

## Metadata
- Programming Languages: Java
- Frameworks: Springboot
- Libraries: (none)
- Databases: postgress
- Tools: (none)
- Best Practices: (none)
- Performance Metrics: (none)
- Security Standards: (none)

## Structure
- repository_before/: baseline code (`__init__.py`)
- repository_after/: optimized code (`__init__.py`)
- tests/: test suite (`__init__.py`)
- evaluation/: evaluation scripts (`evaluation.py`)
- instances/: sample/problem instances (JSON)
- patches/: patches for diffing
- trajectory/: notes or write-up (Markdown)

## Quick start
- Run tests locally: `python -m pytest -q tests`
- With Docker: `docker compose up --build --abort-on-container-exit`
- Add dependencies to `requirements.txt`

## Notes
- Keep commits focused and small.
- Open a PR when ready for review.
