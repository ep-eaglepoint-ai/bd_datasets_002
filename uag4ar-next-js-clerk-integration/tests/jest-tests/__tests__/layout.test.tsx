import { render, screen } from '@testing-library/react'
import { describe, it, expect, jest } from '@jest/globals'
import RootLayout from '../layout'

// Mock the next/font/google modules
jest.mock('next/font/google', () => ({
  Geist: () => ({
    variable: '--font-geist-sans',
  }),
  Geist_Mono: () => ({
    variable: '--font-geist-mono',
  }),
}))

// Mock the CSS import
jest.mock('../globals.css', () => ({}))

describe('RootLayout', () => {
  it('renders ClerkProvider wrapping the application', () => {
    const { container } = render(
      <RootLayout>
        <div>Test Children</div>
      </RootLayout>
    )

    // Verify that the layout structure is correct
    expect(container.querySelector('html')).toBeInTheDocument()
    expect(container.querySelector('body')).toBeInTheDocument()
    
    // Verify that children are rendered
    expect(screen.getByText('Test Children')).toBeInTheDocument()
    
    // Verify ClerkProvider is present (through mocked implementation)
    // The ClerkProvider mock just returns children, so we verify structure
    const body = container.querySelector('body')
    expect(body).toBeInTheDocument()
    expect(body?.children).toHaveLength(1) // ClerkProvider wrapper
  })

  it('renders header with app title', () => {
    render(
      <RootLayout>
        <div>Test Children</div>
      </RootLayout>
    )

    expect(screen.getByText('My Clerk App')).toBeInTheDocument()
  })

  it('renders SignedIn and SignedOut components', () => {
    render(
      <RootLayout>
        <div>Test Children</div>
      </RootLayout>
    )

    // These should be rendered based on our mock
    expect(screen.getByTestId('signed-in')).toBeInTheDocument()
    expect(screen.getByTestId('signed-out')).toBeInTheDocument()
    expect(screen.getByTestId('user-button')).toBeInTheDocument()
  })

  it('applies correct CSS classes and styles', () => {
    const { container } = render(
      <RootLayout>
        <div>Test Children</div>
      </RootLayout>
    )

    const html = container.querySelector('html')
    expect(html).toHaveAttribute('lang', 'en')

    const body = container.querySelector('body')
    expect(body).toHaveClass(/geist-sans/)
    expect(body).toHaveClass(/geist-mono/)
    expect(body).toHaveClass('antialiased')

    const header = container.querySelector('header')
    expect(header).toHaveStyle({ padding: '12px' })
  })

  it('has proper metadata configuration', () => {
    // Import the metadata directly from the layout file
    // Since metadata is a static export, we need to access it differently
    const layoutModule = require('../layout.tsx')
    expect(layoutModule.metadata).toEqual({
      title: 'Create Next App',
      description: 'Generated by create next app',
    })
  })

  it('renders children within the layout structure', () => {
    const { container } = render(
      <RootLayout>
        <main data-testid="main-content">
          <h1>Page Content</h1>
        </main>
      </RootLayout>
    )

    const mainContent = container.querySelector('[data-testid="main-content"]')
    expect(mainContent).toBeInTheDocument()
    expect(screen.getByText('Page Content')).toBeInTheDocument()
  })

  it('maintains proper DOM hierarchy', () => {
    const { container } = render(
      <RootLayout>
        <div>Test Content</div>
      </RootLayout>
    )

    // Verify the DOM structure: html > body > ClerkProvider > header + children
    const html = container.querySelector('html')
    const body = html?.querySelector('body')
    
    expect(body?.children).toHaveLength(1) // ClerkProvider
    
    const clerkProvider = body?.firstElementChild
    expect(clerkProvider?.children.length).toBeGreaterThan(1) // header + children
    
    const header = clerkProvider?.querySelector('header')
    expect(header).toBeInTheDocument()
  })
})
