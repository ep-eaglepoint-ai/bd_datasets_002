version: '3.8'

services:
  repository-before:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./evaluation/reports:/app/evaluation/reports
    command: >
      sh -c "
        echo '================================================' &&
        echo 'ðŸ”´ Testing BEFORE version (Original Code)' &&
        echo '================================================' &&
        cp repository_before/BillSplitter.js ./BillSplitter.js &&
        npm run test 2>&1 || echo 'âš ï¸  Some tests failed on BEFORE version'
      "
    environment:
      - NODE_ENV=test

  repository-after:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./evaluation/reports:/app/evaluation/reports
    command: >
      sh -c "
        echo '================================================' &&
        echo 'ðŸŸ¢ Testing AFTER version (Optimized Code)' &&
        echo '================================================' &&
        cp repository_after/BillSplitter.js ./BillSplitter.js &&
        npm run test:coverage
      "
    environment:
      - NODE_ENV=test

  evaluation:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./evaluation/reports:/app/evaluation/reports
    command: >
      sh -c "
        echo '================================================' &&
        echo 'ðŸ“Š Running Full Evaluation' &&
        echo '================================================' &&
        node evaluation/evaluation.js
      "
    environment:
      - NODE_ENV=test