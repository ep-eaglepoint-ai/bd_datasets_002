services:
  test-before:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/app
    working_dir: /app
    command: >
      sh -c "
        sed -i 's|./repository_after|./repository_before|' go.mod &&
        go test -v ./... || true
      "

  test-after:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/app
    working_dir: /app
    command: >
      sh -c "
        sed -i 's|./repository_before|./repository_after|' go.mod &&
        go test -v -tags=after ./...
      "

  evaluate:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - .:/app
    working_dir: /app
    command: >
      sh -c "
        go mod tidy &&
        go run evaluation/evaluation.go
      "
