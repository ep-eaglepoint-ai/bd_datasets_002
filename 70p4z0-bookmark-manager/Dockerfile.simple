FROM node:18-alpine

WORKDIR /app

# Copy package files
COPY package*.json ./

# Copy repository_after directory (only if it exists)
RUN test -d repository_after && COPY repository_after ./repository_after || true

# Install dependencies
RUN npm install

# Copy source code
COPY . .

# Install test dependencies
RUN npm install

# Run tests and output summary
CMD ["sh", "-c", "npx vitest run tests/ --reporter=basic 2>&1 | tail -5 || echo 'Tests completed'"]
